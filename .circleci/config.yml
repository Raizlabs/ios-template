version: 2
jobs:
  test:
    environment:
      FASTLANE_SKIP_UPDATE_CHECK: 1
    macos:
      xcode: "9.2.0"
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      - run:
          name: Set Ruby Version
          command: |
            echo "ruby-2.4" > ~/.ruby-version
            chruby
      - restore_cache:
          key: 1-gems-{{ checksum "./PRODUCTNAME/Gemfile.lock" }}
      - run:
          name: Restore Gems
          command: |
           export BUNDLE_GEMFILE=./PRODUCTNAME/Gemfile
           bundle check || bundle install --path vendor/bundle
      - save_cache:
          key: 1-gems-{{ checksum "./PRODUCTNAME/Gemfile.lock" }}
          paths:
            - vendor/bundle
      - run:
          name: Install Cookiecutter
          command: pip install cookiecutter
      - run:
          name: Test Cookiecutter Template
          command: |
            echo Testing branch ${CIRCLE_BRANCH}
            cookiecutter --no-input https://github.com/raizlabs/ios-template.git --checkout ${CIRCLE_BRANCH} 
      - run:
          name: Fastlane
          command: |
            cd PRODUCTNAME/app
            bundle install
            bundle exec fastlane test

workflows:
  version: 2
  test:
    jobs:
      - test
